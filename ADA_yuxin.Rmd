---
title: "Association Between Duration of Moderate and Vigorous Recreational Physical Activity and Self-Reported Diabetes Among U.S. Adults Aged 40 and Older, NHANES 2017–2018"
author: "Yuxin Jia"
date: "11/30/2025"
output:
  html_document: default
---

## Load packages and open libraries
```{r, echo=TRUE, message = F}
pacman::p_load(odds.n.ends, blorr, lmtest, car, broom, tidyverse, readr, jtools,haven,janitor) 
install.packages("rsvg", type = "source")
install.packages("DiagrammeRsvg")

# tidyverse:data management and visualization
# odds.n.ends: computing sensitivity and specificity, plotting predictive probabilities and ROC curves for logistic regression
# blorr: model fits of logistic regression
# lmtest: likelihood ratio test
# car: compare coefficients
# broom: get cooks d
# readr: import data
# jtools: VIF statistic
```

## Import dataset
```{r, echo=TRUE}

demo <- read_xpt("/Users/yuxinjia/Desktop/ADA/DEMO_J.xpt")  #demographics
phys_act <- read_xpt("/Users/yuxinjia/Desktop/ADA/PAQ_J.xpt")   #physical_activity
diab <- read_xpt("/Users/yuxinjia/Desktop/ADA/DIQ_J.xpt")   # diabetes
med_cond <- read_xpt("/Users/yuxinjia/Desktop/ADA/MCQ_J.xpt")   #Medical_Conditions
bmi <- read_xpt("/Users/yuxinjia/Desktop/ADA/BMX_J.xpt") #BMI
smoke <- read_xpt("/Users/yuxinjia/Desktop/ADA/SMQ_J.xpt") #Smoking status
income <- read_xpt("/Users/yuxinjia/Desktop/ADA/INQ_J.xpt") #Family monthly poverty level category

```


##merge dataset and create variables
```{r}

df_ADA <- demo %>%
  left_join(phys_act, by = "SEQN") %>%
  left_join(diab,    by = "SEQN") %>%
  left_join(med_cond, by = "SEQN") %>%
  left_join(bmi, by = "SEQN") %>%
  left_join(smoke,    by = "SEQN") %>%
  left_join(income, by = "SEQN")

#1.Recode variables, keep all missing data 
### exposure: physical activity
df_ADA <- df_ADA %>%
  rename_with(tolower) %>%
  mutate(
    pad660 = ifelse(pad660 %in% c(7777, 9999, "."), NA, pad660),
    pad675 = ifelse(pad675 %in% c(7777, 9999, "."), NA, pad675),
    pad_total = pad660 + pad675
  )

### outcome: diabetes:1	Yes;2	No;3	Borderline;7	Refused;9	Don't know;.	Missing
df_ADA <- df_ADA %>%
  mutate(
    diabetes = case_when(
      diq010 %in% c(1,3) ~ 1,
      diq010 == 2 ~ 0,
      TRUE ~ NA_real_
    )
  ) 

### ?confounder:race
df_ADA <- df_ADA %>% 
  mutate(
    race_ethnicity = case_when(
      ridreth3 == 3 ~ 1,     # White
      ridreth3 == 4 ~ 2,     # Black
      ridreth3 %in% c(1,2) ~ 3,  # Hispanic
      ridreth3 == 6 ~ 4,     # Asian
      ridreth3 == 7 ~ 5,     # Other
      TRUE ~ NA_real_
    )
  )

### ?confounder:Smoking
df_ADA <- df_ADA %>% 
  mutate(
    smoking = case_when(
      smq020 == 1 & smq040 %in% c(1,2) ~ 1,
      smq020 %in% c(1,2) ~ 0,
      TRUE ~ NA_real_
    )
  )

### ?confounder:Family monthly poverty level category
df_ADA <- df_ADA %>%
  mutate(
    income = case_when(
      indfmmpc == 1 ~ "Monthly poverty level index <= 1.30",
      indfmmpc == 2 ~ "1.30 < Monthly poverty level index <= 1.85",
      indfmmpc == 3 ~ "Monthly poverty level index > 1.85",
      indfmmpc %in% c(7, 9, NA) ~ "Missing",
       TRUE ~ NA_character_
    )
  )

#2.exclude: Cardiovascular disease & cancer
df_ADA <- df_ADA %>%
  mutate(
    congestive_HF = case_when(
      mcq160b == 1 ~ 1,
      mcq160b == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    heart_attack = case_when(
      mcq160e == 1 ~ 1,
      mcq160e == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    coronary_HD = case_when(
      mcq160c == 1 ~ 1,
      mcq160c == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    stroke = case_when(
      mcq160f == 1 ~ 1,
      mcq160f == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    cancer = case_when(
      mcq220 == 1 ~ 1,
      mcq220 == 2 ~ 0,
      TRUE ~ NA_real_
    )
  )

### domain_ADA for table1(age >=40 & no CVD & no cancer)
df_ADA <- df_ADA %>%
  mutate(
    domain_ADA = case_when(
      ridageyr >= 40 &
      cancer != 1 &
      congestive_HF != 1 &
      coronary_HD != 1 &
      stroke != 1 &
      heart_attack != 1 ~ 1,
      TRUE ~ 0
    )
  )

df_ADA_domain <- df_ADA %>% filter(domain_ADA == 1)

#3. Remove missing data: df_clean_ADA for analysis
key_vars <- c("ridageyr", "riagendr", "race_ethnicity", "bmxbmi",
              "smoking", "income", "pad_total", "diabetes")

df_clean_ADA <- df_ADA_domain %>%
  filter(if_all(all_of(key_vars), ~ !is.na(.)))

```

## How final sample was created
```{r}
# Starting sample size
start_N <- nrow(demo)

# Exclusion counts
exclude_age <- sum(df_ADA$ridageyr < 40, na.rm = TRUE)
exclude_cancer <- sum(df_ADA$cancer == 1, na.rm = TRUE)
exclude_cvd <- sum(
  df_ADA$congestive_HF == 1 |
    df_ADA$coronary_HD == 1 |
    df_ADA$stroke == 1 |
    df_ADA$heart_attack == 1,
  na.rm = TRUE
)

# Final analytic sample
final_N <- sum(df_ADA$domain_ADA == 1, na.rm = TRUE)

# Sample flow table
sample_flow <- tibble(
  Step = c(
    "NHANES 2017–2018 Total",
    "Excluded: Age < 40",
    "Excluded: Cancer",
    "Excluded: Cardiovascular disease",
    "Final analytic sample"
  ),
  N = c(
    start_N,
    exclude_age,
    exclude_cancer,
    exclude_cvd,
    final_N
  )
) %>%
  mutate(
    Percent = round((N / start_N) * 100, 1)
  )

# Figure 1: Participant Selection Flowchart
#DiagrammeR for it

install.packages("rsvg", type = "source")
install.packages("DiagrammeRsvg")

library(DiagrammeR)
library(rsvg)

#data from results
start_N <- 9254  
final_N <- 2830  
exclude_age <- 5372
exclude_cancer <- 588
exclude_cvd <- 641

# flow graph
figure1 <- grViz(diagram = "
digraph flowchart {
  
  # setting
  graph [rankdir = TB, 
         fontname = Helvetica, 
         fontsize = 14,
         ranksep = 0.5,
         nodesep = 0.3]
  
  # 
  node [fontname = Helvetica, 
        shape = rectangle, 
        style = 'filled,rounded',
        fontsize = 13,
        fillcolor = 'lightgrey',
        width = 2.0,
        height = 0.8,
        fixedsize = false]
  
  # nodes
  node1 [label = '@@1', fillcolor = 'white']
  node2 [label = '@@2']
  node3 [label = '@@3']
  node4 [label = '@@4']
  node5 [label = '@@5', fillcolor = 'lightblue']
  
  # link
  edge [color = 'black', penwidth = 1.5]
  
  node1 -> node2 -> node3 -> node4 -> node5
}

# label
[1]: 'NHANES 2017-2018 Total Participants\\nN = 9,254'
[2]: 'Excluded: Age < 40 years\\nn = 5,372 (58.1%)'
[3]: 'Excluded: History of Cancer\\nn = 588 (6.4%)'
[4]: 'Excluded: Cardiovascular Disease\\nn = 641(6.9%)'
[5]: 'Final Analytic Sample\\nN = 2,830 (30.6%)'
")

figure1

# export PNG
figure1 %>%
  DiagrammeRsvg::export_svg() %>%
  charToRaw() %>%
  rsvg::rsvg_png("Figure1.png", width = 1200, height = 900)
```


##table1 
```{r}

# Load table1
pacman::p_load(table1, htmltools)

# Convert variables to factors where helpful
df_ADA_domain <- df_ADA_domain %>%
  mutate(
    Sex = factor(riagendr, labels = c("Male", "Female")),
    RaceEthnicity = factor(race_ethnicity,
                    labels = c("White", "Black", "Hispanic", "Asian", "Other")),
    SmokingStatus = factor(smoking, labels = c("No", "Yes")),
    Diabetes = factor(diabetes, labels = c("No", "Yes")),
    Poverty_level = factor(income,
                           labels = c(
                             "Monthly poverty level index <= 1.30",
                             "1.30 < Monthly poverty level index <= 1.85",
                             "Monthly poverty level index > 1.85",
                             "Missing"
                           ))
  )


tab1_ADA <- table1(
  ~ ridageyr + Sex + RaceEthnicity + bmxbmi + Poverty_level + Diabetes + pad_total ,
  data = df_ADA_domain,
  overall = "Total",
  rowlabelhead = "Variable",
)

library(htmltools)

label(df_ADA_domain$ridageyr) <- HTML("<b>Age (years)</b>")
label(df_ADA_domain$riagendr) <- HTML("<b>Sex</b>")
label(df_ADA_domain$race_ethnicity) <- HTML("<b>Race / ethnicity</b>")
label(df_ADA_domain$bmxbmi) <- HTML("<b>BMI (kg/m²)</b>")
label(df_ADA_domain$smoking) <- HTML("<b>Smoking status</b>")
label(df_ADA_domain$income) <- HTML("<b>Income level</b>")
label(df_ADA_domain$pad_total) <- HTML("<b>Physical activity (min)</b>")
label(df_ADA_domain$diabetes) <- HTML("<b>Diabetes status</b>")


# Print table
tab1_ADA

install.packages("webshot2")
library(webshot2)

# First save HTML
save_html(tab1_ADA, "Table1_ADA.html")

# Then convert to PNG
webshot("Table1_ADA.html", "Table1_ADA.png", vwidth = 1200, vheight = 800)

```


## weighted dataset for analysis

```{r}
install.packages("survey")
install.packages("srvyr")

library(survey)
library(srvyr)

df_clean_ADA <- df_clean_ADA %>%
  mutate(
    wt = wtmec2yr,
    psu = sdmvpsu,
    strata = sdmvstra
  )

nh_srvyr <- df_clean_ADA %>%
  as_survey_design(
    ids = psu,
    strata = strata,
    weights = wt,
    nest = TRUE
  )
# NHANES uses a complex, multistage probability sampling design. 
# To obtain nationally representative estimates, analyses must apply 
# the proper survey weights along with the corresponding PSU and 
# stratification variables.
#
# Because our exposure (physical activity), outcome (diabetes status), 
# and most covariates come from MEC-examined participants, the correct 
# weight is WTMEC2YR. This weight accounts for differential probability 
# of selection, nonresponse, and post-stratification. 
#If using questionnaire-only variables, might use WTINT2YR instead.
#
# Using WTMEC2YR ensures that our analytic sample represents the U.S. 
# civilian non-institutionalized population during the corresponding 
# NHANES cycle and avoids biased estimates that would occur if the 
# sample were treated as simple random data.
```

## Model1: Run a univariable (unadjusted) logistic model for physical activity as a continuous variable. 

```{r}
df_clean_ADA <- df_clean_ADA %>% mutate(pad60 = pad_total / 60)

model1<- glm(diabetes ~ pad60, data=df_clean_ADA, family="binomial")

summary(model1, exponentiate = TRUE, conf.int = TRUE) # get log results

odds.n.ends(model1) # get OR results (and more!) 
```

# Test1: the linearity assumption for physical activity using the Box Tidwell test.

We need to create a term for the x\*log(x) and then run a logistic regression with that term. Remember, a SIGNIFICANT (i.e. p \< .05) coefficient means the assumption IS VIOLATED and we should consider using a categorized measure of BMI. What would your conclusion be about the linearity assumption?

```{r}
 df_clean_ADA<- df_clean_ADA %>%
  mutate(pad60.times.logpad60 = pad60 * log(pad60)) # create term to test linearity

model2 <- glm(diabetes ~ pad60 + pad60.times.logpad60, data=df_clean_ADA, family="binomial") # Box Tidwell test

summary(model2,exponentiate = TRUE, conf.int = TRUE)
```
# Model3: adjust for CONFOUNDERS

```{r}
# adjust for sex and run model and get results
model3 <- glm(diabetes ~  pad60 + ridageyr + riagendr + race_ethnicity + bmxbmi + smoking + income, data=df_clean_ADA, family="binomial")

odds.n.ends(model3)

summary(model3,exponentiate = TRUE, conf.int = TRUE) # get log results

# compare coefficients between models 1 and 3
compareCoefs(model1, model3)
```

## Look at assumptions of multicollinearity using the vif function from the car package

```{r}
vif(model3)

# another way from the jtools package
summ(model3, vifs = TRUE)
# cutoff references: https://quantifyinghealth.com/vif-threshold/
# df is the degrees of freedom associated with the term
```

## Lets look for influential observations using Cook's distance.

```{r}
plot(model3, which = 4, id.n = 3, col="red") 

# Add Cook's distance to the dataset
model3_data <- augment(model3) %>%
  mutate(index = 1:n())

head(model3_data)

# define cutoff variable as 1
cutoff1 <- 1

model3_in1 <- model3_data %>%
  filter(.cooksd < cutoff1)

nrow(model3_in1) / nrow(df_clean_ADA)  
 # no observations are excluded

# define cutoff variable as 4 / n
cutoff2 <- 4 / nrow(df_clean_ADA)
model3_in2 <- model3_data %>%
  filter(.cooksd < cutoff2)

nrow(model3_in2) / nrow(df_clean_ADA)  # proportion of points below cutoff
1 - nrow(model3_in2) / nrow(df_clean_ADA)  # proportion of points considered influential

## check our variables by diabetes_binary in models with and without influential points
table(model3_in2$smoking, model3_in2$diabetes)
table(df_clean_ADA$smoking, df_clean_ADA$diabetes)

# Decision: Only exclude if influential points are clearly problematic, otherwise keep to avoid selection bias
#model does not have any extreme outliers that threaten the stability of coefficients.
#Observations 144, 158, and 296 are the most influential, but they are not extreme enough to remove.
```


## Let's use model3 for model fit assessment (before exclusions)

```{r}
# Various pseudo R squares, log likelihood, deviance, AIC, BIC
blr_model_fit_stats(model3)

# Log-Lik: A better model fit is one with a higher Log-Lik

# Hosmer lemeshow goodness of fit test: a significant p value indicates a bad fit
blr_test_hosmer_lemeshow(model3)

# for more on the inner workings of this test see: https://thestatsgeek.com/2014/02/16/the-hosmer-lemeshow-goodness-of-fit-test-for-logistic-regression/
# bottom line: a good model fit is indicated by a p-value for the goodness of fit test of >.05.
```

## Compare the full model to the reduced model with the lrtest function that compares log-likelihoods. Does income_3L significantly improve model fit?

```{r}
# likelihood ratio test: compare two nested models
lrtest(model1, model3)
```


















